version: "3"
services:
    front:
        build: front/project-sharing-page

    userapi:
        build: userapi
        links:
            - userdb
        depends_on:
            - userdb
        environment:
            POSTGRES_USER: "postgres"
            POSTGRES_PASSWORD: "pg_password"
            DB_ECHO: "False"
        volumes:
            - useiconmedia:/usericon
    
    projectapi:
        build: projectapi
        links:
            - projectdb
        depends_on:
            - projectdb
        environment:
            POSTGRES_USER: "postgres"
            POSTGRES_PASSWORD: "pg_password"
            DB_ECHO: "False"
        volumes:
            - projectimagemedia:/projectimage
    
    chatapi:
        build: chatapi
        links:
            - chatdb
        depends_on:
            - chatdb
        environment:
            POSTGRES_USER: "postgres"
            POSTGRES_PASSWORD: "pg_password"
            DB_ECHO: "False"

    recommendapi:
        build: recommendapi
        links:
            - recommendcache
            - recommendengine
        depends_on:
            - recommendengine
    
    recommendengine:
        build: recommendengine
        links:
            - recommendcache
        depends_on:
            - recommendcache
    
    recommendcache:
        image: redis
        volumes:
            - recommendcachedata

    caddy:
        image: caddy
        volumes:
            - "./Caddyfile:/etc/caddy/Caddyfile"
        links:
            - userapi
            - front
        environment: 
            TZ: "UTC"
            HOSTNAME: "localhost"
        depends_on:
            - userapi
            - front
        ports:
            - 80:80
            - 443:443

    userdb:
        image: postgres
        environment: 
            POSTGRES_USER: "postgres"
            POSTGRES_PASSWORD: "pg_password"  # WARNING: 運用するときにはパスワードを変える・隠す
        volumes:
            - "userpgdata:/var/lib/postgresql/data"
    
    projectdb:
        image: postgres
        environment: 
            POSTGRES_USER: "postgres"
            POSTGRES_PASSWORD: "pg_password"  # WARNING: 運用するときにはパスワードを変える・隠す
        volumes:
            - "projectpgdata:/var/lib/postgresql/data"
    
    chatdb:
        image: postgres
        environment: 
            POSTGRES_USER: "postgres"
            POSTGRES_PASSWORD: "pg_password"  # WARNING: 運用するときにはパスワードを変える・隠す
        volumes:
            - "chatpgdata:/var/lib/postgresql/data"
    
    recommenddb:
        image: postgres
        environment: 
            POSTGRES_USER: "postgres"
            POSTGRES_PASSWORD: "pg_password"  # WARNING: 運用するときにはパスワードを変える・隠す
        volumes:
            - "recommendpgdata:/var/lib/postgresql/data"

volumes: 
    userpgdata:
        driver: "local"
    usericonmedia:
        driver: "local"
    projectpgdata:
        driver: "local"
    projectimagemedia:
        driver: "local"
    chatpgdata:
        driver: "local"
    recommendcachedata:
        driver: "local"
